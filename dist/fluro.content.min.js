angular.module("fluro.content",["fluro.util","ngResource"]),angular.module("fluro.content").service("FluroContent",function($resource,CacheManager,Fluro){var controller={};return controller.resource=function(type,ignoreLoadingBar,noCache){var cache=CacheManager.get(type);return noCache&&(cache=!1),$resource(Fluro.apiURL+"/content/"+type+"/:id",{},{update:{method:"PUT",ignoreLoadingBar:ignoreLoadingBar},save:{method:"POST",ignoreLoadingBar:ignoreLoadingBar},query:{method:"GET",isArray:!0,cache:cache,ignoreLoadingBar:!0},batch:{method:"POST",ignoreLoadingBar:!0}})},controller.endpoint=function(path,ignoreLoadingBar,noCache){var cache=CacheManager.get(path);return noCache&&(cache=!1),$resource(Fluro.apiURL+"/"+path,{},{update:{method:"PUT",ignoreLoadingBar:ignoreLoadingBar},save:{method:"POST",ignoreLoadingBar:ignoreLoadingBar},query:{method:"GET",isArray:!0,cache:cache,ignoreLoadingBar:!0},batch:{method:"POST",ignoreLoadingBar:!0}})},controller}),angular.module("fluro.content").service("FluroContentRetrieval",function($cacheFactory,Fluro,$q,$http){var controller={},cache={};return controller.getCollection=function(id,noCache){var deferred=$q.defer(),url=Fluro.apiURL+"/content/_collection/"+id;return noCache&&(url+="?noCache=true"),$http.get(url).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.getMultipleCollections=function(ids,noCache){var deferred=$q.defer(),url=Fluro.apiURL+"/content/_collection/multiple";return noCache&&(url+="?noCache=true"),$http.post(url,ids).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.query=function(queryDetails,typeName,id,noCache){var url,deferred=$q.defer();return id&&(url=Fluro.apiURL+"/content/_query/"+id,noCache&&(url+="?noCache=true"),$http.get(url).then(function(res){deferred.resolve(res.data)})),typeName&&typeName.length?(url=Fluro.apiURL+"/content/"+typeName+"/_query",noCache&&(url+="?noCache=true"),$http.post(url,queryDetails).then(function(res){deferred.resolve(res.data)})):(url=Fluro.apiURL+"/content/_query",noCache&&(url+="?noCache=true"),$http.post(url,queryDetails).then(function(res){deferred.resolve(res.data)})),deferred.promise},controller.queryMultiple=function(ids,noCache){var deferred=$q.defer(),url=Fluro.apiURL+"/content/_query/multiple";return noCache&&(url+="?noCache=true"),$http({method:"GET",url:url,params:{"ids[]":ids}}).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.populate=function(contentArray,noCache){var ids=_.map(contentArray,function(item){return item._id?item._id:item});return console.log("Populate no cache",noCache),controller.get(ids,noCache)},controller.get=function(ids,noCache){function finish(){var results=_.map(ids,function(id){return cache[id]});deferred.resolve(results)}var deferred=$q.defer(),requiredIds=_.filter(ids,function(id){return!cache[id]});return requiredIds.length?controller.query({_id:{$in:requiredIds}},null,null,noCache).then(function(res){_.each(res,function(item){cache[item._id]=item}),finish()},function(res){deferred.reject(res)}):finish(),deferred.promise},controller});