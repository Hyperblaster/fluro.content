angular.module("fluro.content",["fluro.util","ngResource"]),angular.module("fluro.content").service("FluroContent",function($resource,CacheManager,Fluro){var controller={};return controller.resource=function(type,ignoreLoadingBar,noCache){var cache=CacheManager.get(type);return noCache&&(cache=!1),$resource(Fluro.apiURL+"/content/"+type+"/:id",{},{update:{method:"PUT",ignoreLoadingBar:ignoreLoadingBar},save:{method:"POST",ignoreLoadingBar:ignoreLoadingBar},query:{method:"GET",isArray:!0,cache:cache,ignoreLoadingBar:ignoreLoadingBar},batch:{method:"POST",ignoreLoadingBar:ignoreLoadingBar}})},controller.endpoint=function(path,ignoreLoadingBar,noCache){var cache=CacheManager.get(path);return noCache&&(cache=!1),$resource(Fluro.apiURL+"/"+path,{},{update:{method:"PUT",ignoreLoadingBar:ignoreLoadingBar},save:{method:"POST",ignoreLoadingBar:ignoreLoadingBar},query:{method:"GET",isArray:!0,cache:cache,ignoreLoadingBar:!0},batch:{method:"POST",ignoreLoadingBar:ignoreLoadingBar}})},controller}),angular.module("fluro.content").service("FluroContentRetrieval",function($cacheFactory,Fluro,$q,$http){var controller={},cache={};return controller.getCollection=function(id,noCache){var deferred=$q.defer(),url=Fluro.apiURL+"/content/_collection/"+id;return noCache&&(url+="?noCache=true"),$http.get(url).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.getMultipleCollections=function(ids,noCache){var deferred=$q.defer(),url=Fluro.apiURL+"/content/_collection/multiple";return noCache&&(url+="?noCache=true"),$http({method:"GET",url:url,params:{ids:ids}}).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.getQuery=function(id,options){options||(options={});var deferred=$q.defer(),url=Fluro.apiURL+"/content/_query/"+id;return(options.noCache||options.template)&&(url+="?vars",options.noCache&&(url+="&noCache=true"),options.template&&(url+="&template="+options.template)),$http.get(url).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.query=function(queryDetails,typeName,id,noCache){var url,deferred=$q.defer();return id&&(url=Fluro.apiURL+"/content/_query/"+id,noCache&&(url+="?noCache=true"),$http.get(url).then(function(res){deferred.resolve(res.data)})),typeName&&typeName.length?(url=Fluro.apiURL+"/content/"+typeName+"/_query",noCache&&(url+="?noCache=true"),$http.post(url,queryDetails).then(function(res){deferred.resolve(res.data)})):(url=Fluro.apiURL+"/content/_query",noCache&&(url+="?noCache=true"),$http.post(url,queryDetails).then(function(res){deferred.resolve(res.data)})),deferred.promise},controller.queryMultiple=function(ids,noCache){var deferred=$q.defer(),url=Fluro.apiURL+"/content/_query/multiple";return noCache&&(url+="?noCache=true"),$http({method:"GET",url:url,params:{ids:ids}}).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.retrieveMultiple=function(ids,noCache,params){var deferred=$q.defer(),url=Fluro.apiURL+"/content/multiple";return noCache&&(url+="?noCache=true"),params||(params={}),params.ids=ids,$http({method:"GET",url:url,params:params}).then(function(res){deferred.resolve(res.data)}),deferred.promise},controller.populate=function(contentArray,noCache,searchInheritable){var ids=_.map(contentArray,function(item){return item._id?item._id:item});return controller.get(ids,noCache,searchInheritable)},controller.populatePartial=function(contentArray,fields,noCache,searchInheritable){var deferred=$q.defer(),ids=_.map(contentArray,function(item){return item._id?item._id:item});return controller.retrieveMultiple(ids,noCache,{select:fields,searchInheritable:searchInheritable}).then(deferred.resolve,deferred.reject),deferred.promise},controller.get=function(ids,noCache,searchInheritable){function finish(){var results=_.map(ids,function(id){return cache[id]});deferred.resolve(results)}var deferred=$q.defer(),requiredIds=_.filter(ids,function(id){return!cache[id]});return requiredIds.length?controller.retrieveMultiple(requiredIds,noCache,{searchInheritable:searchInheritable}).then(function(res){_.each(res,function(item){console.log("Create and Cache",item.title),cache[item._id]=item}),finish()},function(res){deferred.reject(res)}):finish(),deferred.promise},controller});